{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Admin Dashboard - Live Orders Feed{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .left-panel, .right-panel {
        background: #1a1a2e;
        border-radius: 12px;
        padding: 25px;
        border: 1px solid #2d2d44;
    }
    
    .left-panel h2, .right-panel h3 {
        color: #ffffff;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(45, 45, 68, 0.8);
        border: 1px solid #2d2d44;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #60a5fa;
        margin-bottom: 8px;
    }
    
    .stat-label {
        color: #8b8b9f;
        font-size: 14px;
        font-weight: 500;
    }
    
    .live-feed-header {
        background: #ffffff;
        color: #374151;
        padding: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .live-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 12px;
    }
    
    .live-dot {
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .live-indicator span {
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .button-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .action-buttons {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .refresh-button {
        background: #3b82f6;
        border: 1px solid #2563eb;
        color: white !important;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .refresh-button:hover {
        background: #2563eb;
        border-color: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .refresh-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .view-all-button {
        background: #f8fafc;
        color: #475569 !important;
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        display: inline-block;
    }
    
    .view-all-button:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        transform: translateY(-1px);
        color: #334155 !important;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    
    .clear-history-button {
        background: #fef2f2;
        color: #dc2626 !important;
        padding: 10px 18px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .clear-history-button:hover {
        background: #fee2e2;
        border-color: #fca5a5;
        transform: translateY(-1px);
        color: #b91c1c !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    
    .clear-history-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        color: #dc2626 !important;
    }
    

    
    /* Force button colors to be readable */
    .live-feed-header button,
    .live-feed-header a {
        color: inherit !important;
    }
    
    .live-feed-header .view-all-button {
        color: #475569 !important;
    }
    
    .live-feed-header .clear-history-button {
        color: #dc2626 !important;
    }
    
    @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
        100% { opacity: 1; transform: scale(1); }
    }
    
    .live-feed-content {
        max-height: 500px;
        overflow-y: auto;
        padding: 0;
        background: #1a1a2e;
    }
    
    .live-feed-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .live-feed-content::-webkit-scrollbar-track {
        background: #2d2d44;
        border-radius: 4px;
    }
    
    .live-feed-content::-webkit-scrollbar-thumb {
        background: #60a5fa;
        border-radius: 4px;
    }
    
    .live-feed-content::-webkit-scrollbar-thumb:hover {
        background: #3b82f6;
    }
    
    .order-item {
        padding: 20px;
        border-bottom: 1px solid #2d2d44;
        transition: all 0.3s ease;
        animation: slideIn 0.5s ease-out;
        background: #1a1a2e;
        position: relative;
        margin-bottom: 2px;
        color: #ffffff !important;
    }
    
    .order-item:hover {
        background: #2d2d44;
        transform: translateX(5px);
        border-left: 3px solid #3b82f6;
    }
    
    .order-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .order-id {
        font-weight: 600;
        color: #60a5fa;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        background: rgba(96, 165, 250, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid rgba(96, 165, 250, 0.3);
        white-space: nowrap;
    }
    
    .order-time {
        font-size: 12px;
        color: #8b8b9f;
        background: rgba(139, 139, 159, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        white-space: nowrap;
    }
    
    .order-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .customer-name {
        font-weight: 500;
        color: #ffffff;
        font-size: 15px;
        flex: 1;
        min-width: 150px;
    }
    
    .order-amount {
        font-weight: 700;
        color: #10b981;
        font-size: 16px;
        background: rgba(16, 185, 129, 0.1);
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid rgba(16, 185, 129, 0.3);
        white-space: nowrap;
    }
    
    .order-status {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .status-paid {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        border: 1px solid #10b981;
    }
    
    .status-pending {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #ffffff;
        border: 1px solid #f59e0b;
    }
    
    .status-failed {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #ffffff;
        border: 1px solid #ef4444;
    }
    
    .status-processing {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
        border: 1px solid #3b82f6;
    }
    
    .order-status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .status-completed {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        border: 1px solid #10b981;
    }
    
    .status-pending-order {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #ffffff;
        border: 1px solid #f59e0b;
    }
    
    .status-cancelled {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #ffffff;
        border: 1px solid #ef4444;
    }
    
    .no-orders {
        padding: 60px 20px;
        text-align: center;
        color: #8b8b9f;
        background: rgba(45, 45, 68, 0.3);
        margin: 20px;
        border-radius: 12px;
        border: 2px dashed #2d2d44;
    }
    
         .no-orders-icon {
         font-size: 64px;
         margin-bottom: 20px;
         opacity: 0.5;
         color: #3b82f6;
     }
     
     .quick-actions-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
         gap: 16px;
         margin-top: 20px;
     }
     
     .quick-action-button {
         background: rgba(59, 130, 246, 0.1);
         border: 1px solid rgba(59, 130, 246, 0.3);
         border-radius: 12px;
         padding: 20px 16px;
         text-decoration: none;
         color: #ffffff !important;
         text-align: center;
         transition: all 0.3s ease;
         display: flex;
         flex-direction: column;
         align-items: center;
         gap: 8px;
     }
     
     .quick-action-button:hover {
         background: rgba(59, 130, 246, 0.2);
         border-color: rgba(59, 130, 246, 0.5);
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
         color: #ffffff !important;
         text-decoration: none;
     }
     
     .action-icon {
         font-size: 24px;
         margin-bottom: 4px;
     }
     
     .action-text {
         font-weight: 600;
         font-size: 13px;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }
     
     /* Advanced Filters Styling */
     .filters-section {
         background: rgba(45, 45, 68, 0.6);
         border: 1px solid #2d2d44;
         border-radius: 12px;
         padding: 20px;
         margin-bottom: 25px;
     }
     
     .filters-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         gap: 15px;
         margin-top: 15px;
     }
     
     .filter-group {
         display: flex;
         flex-direction: column;
         gap: 8px;
     }
     
     .filter-group label {
         color: #8b8b9f;
         font-size: 12px;
         font-weight: 500;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }
     
     .filter-group select {
         background: #2d2d44;
         border: 1px solid #3b82f6;
         border-radius: 8px;
         padding: 10px 12px;
         color: #ffffff;
         font-size: 13px;
         transition: all 0.3s ease;
     }
     
     .filter-group select:focus {
         outline: none;
         border-color: #60a5fa;
         box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
     }
     
     .custom-date-range {
         margin-top: 15px;
         padding-top: 15px;
         border-top: 1px solid #2d2d44;
     }
     
     .date-inputs {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 15px;
     }
     
     .date-input {
         display: flex;
         flex-direction: column;
         gap: 8px;
     }
     
     .date-input label {
         color: #8b8b9f;
         font-size: 12px;
         font-weight: 500;
         text-transform: uppercase;
         letter-spacing: 0.5px;
     }
     
     .date-input input[type="date"] {
         background: #2d2d44;
         border: 1px solid #3b82f6;
         border-radius: 8px;
         padding: 10px 12px;
         color: #ffffff;
         font-size: 13px;
         transition: all 0.3s ease;
     }
     
     .date-input input[type="date"]:focus {
         outline: none;
         border-color: #60a5fa;
         box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
     }
     
     /* Enhanced Stats with Change Indicators */
     .stat-change {
         font-size: 11px;
         font-weight: 600;
         margin-top: 5px;
         padding: 2px 6px;
         border-radius: 4px;
         text-align: center;
     }
     
     .stat-change.positive {
         color: #10b981;
         background: rgba(16, 185, 129, 0.1);
         border: 1px solid rgba(16, 185, 129, 0.3);
     }
     
     .stat-change.negative {
         color: #ef4444;
         background: rgba(239, 68, 68, 0.1);
         border: 1px solid rgba(239, 68, 68, 0.3);
     }
     
     .stat-change.neutral {
         color: #8b8b9f;
         background: rgba(139, 139, 159, 0.1);
         border: 1px solid rgba(139, 139, 159, 0.3);
     }
     
     /* Performance Metrics */
     .performance-section {
         background: rgba(45, 45, 68, 0.6);
         border: 1px solid #2d2d44;
         border-radius: 12px;
         padding: 20px;
         margin-bottom: 25px;
     }
     
     .metrics-grid {
         display: grid;
         grid-template-columns: 1fr;
         gap: 20px;
         margin-top: 15px;
     }
     
     .metric-item {
         display: flex;
         align-items: center;
         gap: 15px;
         padding: 15px;
         background: rgba(45, 45, 68, 0.4);
         border-radius: 8px;
         border: 1px solid #2d2d44;
     }
     
     .metric-label {
         color: #8b8b9f;
         font-size: 13px;
         font-weight: 500;
         min-width: 120px;
     }
     
     .metric-value {
         color: #60a5fa;
         font-size: 18px;
         font-weight: 700;
         min-width: 60px;
         text-align: center;
     }
     
     .metric-bar {
         flex: 1;
         height: 8px;
         background: #2d2d44;
         border-radius: 4px;
         overflow: hidden;
     }
     
     .metric-fill {
         height: 100%;
         background: linear-gradient(90deg, #3b82f6, #60a5fa);
         border-radius: 4px;
         transition: width 0.8s ease;
     }
     
     /* Search Input Styling */
     .search-section {
         margin-right: 15px;
     }
     
     .search-input {
         background: #f8fafc;
         border: 1px solid #e2e8f0;
         border-radius: 8px;
         padding: 10px 15px;
         font-size: 13px;
         color: #374151;
         width: 250px;
         transition: all 0.3s ease;
     }
     
     .search-input:focus {
         outline: none;
         border-color: #3b82f6;
         box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
         background: #ffffff;
     }
     
     .search-input::placeholder {
         color: #9ca3af;
     }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- LEFT PANEL: Store Overview & Stats -->
         <div class="left-panel">
         <h2>📊 Store Overview</h2>
         
         <!-- Advanced Filters -->
         <div class="filters-section">
             <h4 style="color: #ffffff; margin: 20px 0 15px 0; font-size: 16px; font-weight: 600;">
                 🔍 Advanced Filters
             </h4>
             <div class="filters-grid">
                 <div class="filter-group">
                     <label for="dateRange">Date Range:</label>
                     <select id="dateRange" onchange="applyFilters()">
                         <option value="today">Today</option>
                         <option value="yesterday">Yesterday</option>
                         <option value="week" selected>This Week</option>
                         <option value="month">This Month</option>
                         <option value="custom">Custom Range</option>
                     </select>
                 </div>
                 <div class="filter-group">
                     <label for="paymentStatus">Payment Status:</label>
                     <select id="paymentStatus" onchange="applyFilters()">
                         <option value="all">All Statuses</option>
                         <option value="paid">Paid</option>
                         <option value="pending">Pending</option>
                         <option value="failed">Failed</option>
                         <option value="cancelled">Cancelled</option>
                     </select>
                 </div>
                 <div class="filter-group">
                     <label for="orderStatus">Order Status:</label>
                     <select id="orderStatus" onchange="applyFilters()">
                         <option value="all">All Statuses</option>
                         <option value="pending">Pending</option>
                         <option value="fulfilled">Fulfilled</option>
                         <option value="cancelled">Cancelled</option>
                     </select>
                 </div>
                 <div class="filter-group">
                     <label for="paymentMethod">Payment Method:</label>
                     <select id="paymentMethod" onchange="applyFilters()">
                         <option value="all">All Methods</option>
                         <option value="stripe">Stripe</option>
                         <option value="whatsapp">WhatsApp</option>
                     </select>
                 </div>
             </div>
             <div class="custom-date-range" id="customDateRange" style="display: none;">
                 <div class="date-inputs">
                     <div class="date-input">
                         <label for="startDate">From:</label>
                         <input type="date" id="startDate" onchange="applyFilters()">
                     </div>
                     <div class="date-input">
                         <label for="endDate">To:</label>
                         <input type="date" id="endDate" onchange="applyFilters()">
                     </div>
                 </div>
             </div>
         </div>
         
         <!-- Enhanced Stats Grid -->
         <div class="stats-grid">
             <div class="stat-card">
                 <div class="stat-value" id="todaySales">${{ today_sales|floatformat:2 }}</div>
                 <div class="stat-label">Today's Sales</div>
                                   <div class="stat-change" id="salesChange">This Week</div>
              </div>
              <div class="stat-card">
                  <div class="stat-value" id="todayOrders">{{ today_orders }}</div>
                  <div class="stat-label">Today's Orders</div>
                  <div class="stat-change" id="ordersChange">This Week</div>
              </div>
              <div class="stat-card">
                  <div class="stat-value" id="todayAvg">${{ today_avg|floatformat:2 }}</div>
                  <div class="stat-label">Avg Order Value</div>
                  <div class="stat-change" id="avgChange">This Week</div>
             </div>

         </div>
          
          <!-- Performance Metrics -->
          <div class="performance-section">
              <h4 style="color: #ffffff; margin: 25px 0 15px 0; font-size: 16px; font-weight: 600;">
                  📈 Performance Metrics
              </h4>
                             <div class="metrics-grid">
                   <div class="metric-item">
                       <div class="metric-label">All Users</div>
                       <div class="metric-value" id="newCustomerRate">--</div>
                       <div class="metric-bar">
                           <div class="metric-fill" id="newCustomerBar" style="width: 0%;"></div>
                       </div>
                   </div>
                   <div class="metric-item">
                       <div class="metric-label">Avg Order Change</div>
                       <div class="metric-value" id="avgOrderChange">--</div>
                       <div class="metric-bar">
                           <div class="metric-fill" id="avgOrderBar" style="width: 0%;"></div>
                       </div>
                   </div>
                   <div class="metric-item">
                       <div class="metric-label">Orders per Customer</div>
                       <div class="metric-value" id="ordersPerCustomer">--</div>
                       <div class="metric-bar">
                           <div class="metric-fill" id="ordersPerBar" style="width: 0%;"></div>
                       </div>
                   </div>
               </div>
          </div>
          
          <h3 style="color: #ffffff; margin: 30px 0 20px 0; font-size: 20px; font-weight: 600; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">
              🚀 Quick Actions
          </h3>
          <div class="quick-actions-grid">
              <a href="{% url 'admin:store_product_changelist' %}" class="quick-action-button">
                  <span class="action-icon">📦</span>
                  <span class="action-text">Products</span>
              </a>
              <a href="{% url 'admin:store_cartorder_changelist' %}" class="quick-action-button">
                  <span class="action-icon">🛒</span>
                  <span class="action-text">Cart Orders</span>
              </a>
              <a href="{% url 'admin:store_category_changelist' %}" class="quick-action-button">
                  <span class="action-icon">🏷️</span>
                  <span class="action-text">Categories</span>
              </a>
              <a href="{% url 'admin:store_coupon_changelist' %}" class="quick-action-button">
                  <span class="action-icon">🎫</span>
                  <span class="action-text">Coupons</span>
              </a>
          </div>
    </div>
    
    <!-- RIGHT PANEL: Live Cart Orders Feed -->
    <div class="right-panel">
        <h3>Live Cart Orders Feed</h3>
        <div class="live-feed-container">
            <div class="live-feed-header">
                <div class="header-left">
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>LIVE</span>
                    </div>
                    
                </div>
                                 <div class="header-right">
                     <div class="search-section">
                         <input type="text" id="orderSearch" placeholder="Search orders..." class="search-input" onkeyup="searchOrders()">
                     </div>
                     <div class="button-group">
                         <button class="refresh-button" onclick="refreshOrders()" type="button">Refresh</button>
                     </div>
                     <div class="action-buttons">
                         <a href="{% url 'admin:store_product_changelist' %}" class="view-all-button">
                             View All Products
                         </a>
                         <a href="{% url 'admin:store_cartorder_changelist' %}" class="view-all-button">
                             View All Cart Orders
                         </a>
                         <button class="clear-history-button" onclick="clearWeeklyHistory()" type="button">
                             Clear Weekly History
                         </button>
                     </div>
                 </div>
            </div>
            <div class="live-feed-content" id="ordersFeed">
                {% if recent_orders %}
                    {% for order in recent_orders %}
                        <div class="order-item" data-order-id="{{ order.id }}">
                            <div class="order-header">
                                <span class="order-id">{{ order.oid }}</span>
                                <span class="order-time">{{ order.date|timesince }} ago</span>
                            </div>
                            <div class="order-details">
                                <span class="customer-name">
                                    {% if order.buyer %}
                                        {{ order.buyer.username }}
                                    {% else %}
                                        {{ order.full_name|default:"Guest Customer" }}
                                    {% endif %}
                                </span>
                                <span class="order-amount">${{ order.total|floatformat:2 }}</span>
                            </div>
                            <div class="order-status">
                                <span class="status-badge status-{{ order.payment_status|lower }}">{{ order.payment_status|title }}</span>
                                <span class="order-status-badge status-{{ order.order_status|lower }}">
                                    {{ order.order_status|title }}
                                </span>
                                {% if order.payment_method == 'whatsapp' %}
                                    <span class="whatsapp-badge">WhatsApp Order</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-orders">
                        <div class="no-orders-icon">📋</div>
                        <p>No orders yet</p>
                        <p>Orders will appear here in real-time</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Global flag to prevent auto-refresh from interfering with manual filter changes
let filtersBeingApplied = false;

function refreshOrders() {
     // Don't refresh if filters are being applied manually
     if (filtersBeingApplied) {
         console.log('⏸️ Manual refresh blocked - filters being applied');
         return;
     }
     console.log('🔄 Manual refresh running with current filters');
    
    const refreshButton = document.querySelector('.refresh-button');
    if (refreshButton) {
        refreshButton.disabled = true;
        refreshButton.textContent = 'Refreshing...';
    }
    
    // Get current active filters
    const currentFilters = {
        time_period: document.getElementById('dateRange')?.value || 'week',
        payment_status: document.getElementById('paymentStatus')?.value || 'all',
        order_status: document.getElementById('orderStatus')?.value || 'all',
        payment_method: document.getElementById('paymentMethod')?.value || 'all'
    };
    
    // Build query string with current filters
    const params = new URLSearchParams();
    Object.keys(currentFilters).forEach(key => {
        if (currentFilters[key] && currentFilters[key] !== 'all') {
            params.append(key, currentFilters[key]);
        }
    });
    
         // Fetch filtered data from backend
     console.log('🔄 Manual refresh fetching data with filters:', currentFilters);
     fetch(`/store/admin/live-orders/?${params.toString()}`)
        .then(response => response.json())
                 .then(data => {
             if (data.success) {
                 console.log('📋 Orders feed updated with filtered data:', data.orders.length, 'orders');
                 updateOrdersFeed(data.orders);
                 updateStats(data.stats);
                 localStorage.removeItem('feedCleared');
                 localStorage.removeItem('feedClearedAt');
             }
         })
        .catch(error => {
            console.error('Error refreshing orders:', error);
        })
        .finally(() => {
            setTimeout(() => {
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'Refresh';
                }
            }, 2000);
        });
}

function clearWeeklyHistory() {
    if (confirm('Are you sure you want to clear the weekly live feed history? This will only clear the display, not the actual orders in the database.')) {
        const feed = document.getElementById('ordersFeed');
        const clearButton = document.querySelector('.clear-history-button');
        
        if (clearButton) {
            clearButton.disabled = true;
            clearButton.textContent = 'Clearing...';
        }
        
        localStorage.setItem('feedCleared', 'true');
        localStorage.setItem('feedClearedAt', new Date().toISOString());
        
        feed.innerHTML = `
            <div class="no-orders">
                <div class="no-orders-icon">✓</div>
                <p>Weekly history cleared</p>
                <p>New orders will appear here in real-time</p>
                <small style="color: #8b8b9f;">History cleared at ${new Date().toLocaleString()}</small>
            </div>
        `;
        
        setTimeout(() => {
            if (clearButton) {
                clearButton.disabled = false;
                clearButton.textContent = 'Clear Weekly History';
            }
        }, 3000);
    }
}

function updateOrdersFeed(orders) {
    const feed = document.getElementById('ordersFeed');
    feed.innerHTML = '';
    
    if (orders.length === 0) {
        feed.innerHTML = `
            <div class="no-orders">
                <div class="no-orders-icon">📋</div>
                <p>No orders yet</p>
                <p>Orders will appear here in real-time</p>
            </div>
        `;
        return;
    }
    
    orders.forEach((order, index) => {
        const orderItem = createOrderItem(order);
        feed.appendChild(orderItem);
    });
    

}

function createOrderItem(order) {
    const orderItem = document.createElement('div');
    orderItem.className = 'order-item';
    orderItem.dataset.orderId = order.id;
    
    if (order.payment_method) {
        orderItem.dataset.paymentMethod = order.payment_method;
    }
    
    const orderDate = new Date(order.date);
    const now = new Date();
    const timeDiff = now - orderDate;
    const minutes = Math.floor(timeDiff / 60000);
    const hours = Math.floor(timeDiff / 3600000);
    
    let timeAgo = 'Just now';
    if (minutes > 0 && minutes < 60) {
        timeAgo = `${minutes}m ago`;
    } else if (hours > 0 && hours < 24) {
        timeAgo = `${hours}h ago`;
    } else {
        timeAgo = orderDate.toLocaleDateString();
    }
    
    orderItem.innerHTML = `
        <div class="order-header">
            <span class="order-id">${order.oid || order.id}</span>
            <span class="order-time">${timeAgo}</span>
        </div>
        <div class="order-details">
            <span class="customer-name">${order.customer_name}</span>
            <span class="order-amount">$${order.total.toFixed(2)}</span>
        </div>
        <div class="order-status">
            <span class="status-badge status-${order.payment_status.toLowerCase()}">${order.payment_status}</span>
            <span class="order-status-badge status-${order.order_status.toLowerCase()}">
                ${order.order_status === 'pending' ? 'Fulfilled' : order.order_status}
            </span>
            ${order.payment_method === 'whatsapp' ? '<span class="whatsapp-badge">WhatsApp Order</span>' : ''}
        </div>
        <div class="order-meta">
            <small style="color: #8b8b9f; font-size: 12px;">
                📧 ${order.email} | 📱 ${order.phone || 'N/A'} | 📍 ${order.city}, ${order.country}
            </small>

        </div>
    `;
    

    
    return orderItem;
}





   function updateStats(stats) {
      const todaySales = document.getElementById('todaySales');
      const salesChange = document.getElementById('salesChange');
      const todayOrders = document.getElementById('todayOrders');
      const ordersChange = document.getElementById('ordersChange');
      const todayAvg = document.getElementById('todayAvg');
      const avgChange = document.getElementById('avgChange');

      const newCustomerRate = document.getElementById('newCustomerRate');
      const newCustomerBar = document.getElementById('newCustomerBar');
      const avgOrderChange = document.getElementById('avgOrderChange');
      const avgOrderBar = document.getElementById('avgOrderBar');
      const ordersPerCustomer = document.getElementById('ordersPerCustomer');
      const ordersPerBar = document.getElementById('ordersPerBar');

      // Get current filter period to show correct labels
      const currentPeriod = document.getElementById('dateRange')?.value || 'week';
      let periodLabel = 'This Week';
      let periodClass = 'neutral';
      
      switch(currentPeriod) {
          case 'today':
              periodLabel = 'Today';
              periodClass = 'positive';
              break;
          case 'yesterday':
              periodLabel = 'Yesterday';
              periodClass = 'neutral';
              break;
          case 'week':
              periodLabel = 'This Week';
              periodClass = 'neutral';
              break;
          case 'month':
              periodLabel = 'This Month';
              periodClass = 'neutral';
              break;
          case 'custom':
              periodLabel = 'Custom Range';
              periodClass = 'neutral';
              break;
      }

      // Use filtered stats if available, otherwise fall back to today's stats
      const salesAmount = stats.filtered_sales || stats.today_sales || 0;
      const ordersCount = stats.filtered_orders || stats.today_orders || 0;
      const avgAmount = stats.filtered_avg || stats.today_avg || 0;

      if (todaySales) todaySales.textContent = `$${parseFloat(salesAmount).toFixed(2)}`;
      if (salesChange) {
          salesChange.textContent = periodLabel;
          salesChange.className = `stat-change ${periodClass}`;
      }
      if (todayOrders) todayOrders.textContent = ordersCount;
      if (ordersChange) {
          ordersChange.textContent = periodLabel;
          ordersChange.className = `stat-change ${periodClass}`;
      }
      if (todayAvg) todayAvg.textContent = `$${parseFloat(avgAmount).toFixed(2)}`;
      if (avgChange) {
          avgChange.textContent = periodLabel;
          avgChange.className = `stat-change ${periodClass}`;
      }


      // Update performance metrics if available
      if (stats.performance) {
          if (newCustomerRate) newCustomerRate.textContent = `${stats.performance.total_users || 0}`;
          if (newCustomerBar) newCustomerBar.style.width = `${Math.min((stats.performance.total_users || 0) / 10, 100)}%`;
          if (avgOrderChange) {
              const change = parseFloat(stats.performance.avg_order_change) || 0;
              avgOrderChange.textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
              avgOrderChange.style.color = change >= 0 ? '#10b981' : '#ef4444';
          }
          if (avgOrderBar) avgOrderBar.style.width = `${Math.min(Math.abs(parseFloat(stats.performance.avg_order_change) || 0), 100)}%`;
          if (ordersPerCustomer) ordersPerCustomer.textContent = (parseFloat(stats.performance.orders_per_customer) || 0).toFixed(1);
          if (ordersPerBar) ordersPerBar.style.width = `${Math.min((stats.performance.orders_per_customer || 0) * 20, 100)}%`;
      }
  }
 
 // Advanced Filter Functions
 function applyFilters() {
     // Set flag to prevent auto-refresh interference
     filtersBeingApplied = true;
     console.log('🚀 Starting filter application...');
     
     const dateRange = document.getElementById('dateRange').value;
     const paymentStatus = document.getElementById('paymentStatus').value;
     const orderStatus = document.getElementById('orderStatus').value;
     const paymentMethod = document.getElementById('paymentMethod').value;
     
     console.log('🔍 Applying filters:', { dateRange, paymentStatus, orderStatus, paymentMethod });
     
     // Show/hide custom date inputs
     const customDateRange = document.getElementById('customDateRange');
     if (dateRange === 'custom') {
         customDateRange.style.display = 'block';
     } else {
         customDateRange.style.display = 'none';
     }
     
     // Build filter parameters
     const filters = {
         time_period: dateRange,
         payment_status: paymentStatus,
         order_status: orderStatus,
         payment_method: paymentMethod
     };
     
     if (dateRange === 'custom') {
         const startDate = document.getElementById('startDate').value;
         const endDate = document.getElementById('endDate').value;
         if (startDate && endDate) {
             filters.start_date = startDate;
             filters.end_date = endDate;
         }
     }
     
     // Apply filters to orders feed
     applyFiltersToOrders(filters);
     
     // Update stats based on filters
     updateFilteredStats(filters);
     
     // Call backend API to get filtered data
     fetchFilteredData(filters);
     
     // Also update the orders feed with filtered data
     updateOrdersFeedWithFilters(filters);
     console.log('✅ Filters applied successfully');
     
     // Reset flag after filter application
     setTimeout(() => {
         filtersBeingApplied = false;
         console.log('✅ Filters applied, auto-refresh re-enabled');
         console.log('🎯 Filter application complete - data should now persist');
     }, 1000);
 }

 function fetchFilteredData(filters) {
     // Build query string
     const params = new URLSearchParams();
     Object.keys(filters).forEach(key => {
         if (filters[key] && filters[key] !== 'all') {
             params.append(key, filters[key]);
         }
     });
     
     // Call dashboard stats API
     fetch(`/store/admin/dashboard-stats/?${params.toString()}`)
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 updateDashboardWithFilteredData(data.stats);
             }
         })
         .catch(error => {
             console.error('Error fetching filtered data:', error);
         });
 }

 function updateDashboardWithFilteredData(stats) {
     // Update summary stats
     const summary = stats.summary;
     if (summary) {
         const todaySales = document.getElementById('todaySales');
         const todayOrders = document.getElementById('todayOrders');
         const todayAvg = document.getElementById('todayAvg');

         
         if (todaySales) todaySales.textContent = `$${parseFloat(summary.total_sales || 0).toFixed(2)}`;
         if (todayOrders) todayOrders.textContent = summary.total_orders || 0;
         if (todayAvg) todayAvg.textContent = `$${parseFloat(summary.avg_order_value || 0).toFixed(2)}`;

     }
     
           // Update performance metrics
      const performance = stats.performance;
      if (performance) {
          const newCustomerRate = document.getElementById('newCustomerRate');
          const newCustomerBar = document.getElementById('newCustomerBar');
          const avgOrderChange = document.getElementById('avgOrderChange');
          const avgOrderBar = document.getElementById('avgOrderBar');
          const ordersPerCustomer = document.getElementById('ordersPerCustomer');
          const ordersPerBar = document.getElementById('ordersPerBar');
          
          if (newCustomerRate) newCustomerRate.textContent = `${performance.total_users || 0}`;
          if (newCustomerBar) newCustomerBar.style.width = `${Math.min((performance.total_users || 0) / 10, 100)}%`;
          if (avgOrderChange) {
              const change = parseFloat(performance.avg_order_change) || 0;
              avgOrderChange.textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
              avgOrderChange.style.color = change >= 0 ? '#10b981' : '#ef4444';
          }
          if (avgOrderBar) avgOrderBar.style.width = `${Math.min(Math.abs(performance.avg_order_change || 0), 100)}%`;
          if (ordersPerCustomer) ordersPerCustomer.textContent = (performance.orders_per_customer || 0).toFixed(1);
          if (ordersPerBar) ordersPerBar.style.width = `${Math.min((performance.orders_per_customer || 0) * 20, 100)}%`;
      }
     
     // Update filter indicator
     updateFilterIndicator(stats.filters);
     
     // Update change indicators based on time period
     updateChangeIndicators(stats.filters?.time_period || 'week');
 }
 
 function applyFiltersToOrders(filters) {
    const orderItems = document.querySelectorAll('.order-item');
    
    orderItems.forEach(item => {
        let shouldShow = true;
        
        // Filter by payment method
        if (filters.payment_method !== 'all') {
            const itemPaymentMethod = item.dataset.paymentMethod;
            if (itemPaymentMethod !== filters.payment_method) {
                shouldShow = false;
            }
        }
        
        // Filter by payment status
        if (filters.payment_status !== 'all') {
            const statusBadge = item.querySelector('.status-badge');
            if (statusBadge && !statusBadge.textContent.toLowerCase().includes(filters.payment_status.toLowerCase())) {
                shouldShow = false;
            }
        }
        
        // Filter by order status
        if (filters.order_status !== 'all') {
            const orderStatusBadge = item.querySelector('.order-status-badge');
            if (orderStatusBadge && !orderStatusBadge.textContent.toLowerCase().includes(filters.order_status.toLowerCase())) {
                shouldShow = false;
            }
        }
        
        // Apply visibility
        if (shouldShow) {
            item.style.display = 'block';
            item.style.opacity = '1';
        } else {
            item.style.display = 'none';
            item.style.opacity = '0';
        }
    });
    
    
}
 
 function updateFilteredStats(filters) {
     // This would typically call the backend to get filtered stats
     // For now, we'll update the UI to show filters are active
     const filterIndicator = document.querySelector('.filters-section h4');
     if (filterIndicator) {
         const activeFilters = [];
         if (filters.payment_status !== 'all') activeFilters.push(filters.payment_status);
         if (filters.order_status !== 'all') activeFilters.push(filters.order_status);
         if (filters.payment_method !== 'all') activeFilters.push(filters.payment_method);
         
         if (activeFilters.length > 0) {
             filterIndicator.innerHTML = `🔍 Advanced Filters <span style="color: #60a5fa; font-size: 14px;">(${activeFilters.join(', ')})</span>`;
         } else {
             filterIndicator.innerHTML = '🔍 Advanced Filters';
         }
     }
 }
 
 function updateFilterIndicator(filters) {
     // This would typically call the backend to get filtered stats
     // For now, we'll update the UI to show filters are active
     const filterIndicator = document.querySelector('.filters-section h4');
     if (filterIndicator) {
         const activeFilters = [];
         if (filters.payment_status && filters.payment_status !== 'all') activeFilters.push(filters.payment_status);
         if (filters.order_status && filters.order_status !== 'all') activeFilters.push(filters.order_status);
         if (filters.payment_method && filters.payment_method !== 'all') activeFilters.push(filters.payment_method);
         
         if (activeFilters.length > 0) {
             filterIndicator.innerHTML = `🔍 Advanced Filters <span style="color: #60a5fa; font-size: 14px;">(${activeFilters.join(', ')})</span>`;
         } else {
             filterIndicator.innerHTML = '🔍 Advanced Filters';
         }
     }
 }

function updateChangeIndicators(timePeriod) {
     const salesChange = document.getElementById('salesChange');
     const ordersChange = document.getElementById('ordersChange');
     const avgChange = document.getElementById('avgChange');
     
     let periodText = '';
     let periodClass = 'neutral';
     
     switch(timePeriod) {
         case 'today':
             periodText = 'Today';
             periodClass = 'positive';
             break;
         case 'yesterday':
             periodText = 'Yesterday';
             periodClass = 'neutral';
             break;
         case 'week':
             periodText = 'This Week';
             periodClass = 'neutral';
             break;
         case 'month':
             periodText = 'This Month';
             periodClass = 'neutral';
             break;
         case 'custom':
             periodText = 'Custom Range';
             periodClass = 'neutral';
             break;
         default:
             periodText = 'This Week';
             periodClass = 'neutral';
     }
     
     if (salesChange) {
         salesChange.textContent = periodText;
         salesChange.className = `stat-change ${periodClass}`;
     }
     if (ordersChange) {
         ordersChange.textContent = periodText;
         ordersChange.className = `stat-change ${periodClass}`;
     }
     if (avgChange) {
         avgChange.textContent = periodText;
         avgChange.className = `stat-change ${periodClass}`;
     }
 }
 
 
 
 function updateOrdersFeedWithFilters(filters) {
     // Fetch filtered orders from backend
     const params = new URLSearchParams();
     Object.keys(filters).forEach(key => {
         if (filters[key] && filters[key] !== 'all') {
             params.append(key, filters[key]);
         }
     });
     
     // Call live orders API with filters
     fetch(`/store/admin/live-orders/?${params.toString()}`)
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 updateOrdersFeed(data.orders);
                 updateStats(data.stats);
             }
         })
         .catch(error => {
             console.error('Error fetching filtered orders:', error);
         });
 }
 
 // Enhanced Performance Metrics
 function updatePerformanceMetrics() {
     // Simulate real-time metric updates
     const metricItems = document.querySelectorAll('.metric-item');
     
     metricItems.forEach(item => {
         const metricValue = item.querySelector('.metric-value');
         const metricBar = item.querySelector('.metric-fill');
         
         if (metricValue && metricBar) {
             // Animate the metric bar
             const currentWidth = metricBar.style.width;
             const targetWidth = currentWidth || '0%';
             
             metricBar.style.width = '0%';
             setTimeout(() => {
                 metricBar.style.width = targetWidth;
             }, 100);
         }
     });
 }

 function loadPerformanceMetrics() {
     // Fetch real performance metrics from backend
     fetch('/store/admin/performance-metrics/')
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 updatePerformanceMetricsWithRealData(data.metrics);
             }
         })
         .catch(error => {
             console.error('Error loading performance metrics:', error);
         });
 }

 function updatePerformanceMetricsWithRealData(performance) {
     const newCustomerRate = document.getElementById('newCustomerRate');
     const newCustomerBar = document.getElementById('newCustomerBar');
     const avgOrderChange = document.getElementById('avgOrderChange');
     const avgOrderBar = document.getElementById('avgOrderBar');
     const ordersPerCustomer = document.getElementById('ordersPerCustomer');
     const ordersPerBar = document.getElementById('ordersPerBar');
     
     if (newCustomerRate) newCustomerRate.textContent = `${performance.total_users || 0}`;
     if (newCustomerBar) newCustomerBar.style.width = `${Math.min((performance.total_users || 0) / 10, 100)}%`;
     if (avgOrderChange) {
         const change = parseFloat(performance.avg_order_change) || 0;
         avgOrderChange.textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}%`;
         avgOrderChange.style.color = change >= 0 ? '#10b981' : '#ef4444';
     }
     if (avgOrderBar) avgOrderBar.style.width = `${Math.min(Math.abs(performance.avg_order_change || 0), 100)}%`;
     if (ordersPerCustomer) ordersPerCustomer.textContent = (performance.orders_per_customer || 0).toFixed(1);
     if (ordersPerBar) ordersPerBar.style.width = `${Math.min((performance.orders_per_customer || 0) * 20, 100)}%`;
 }
 
 // Export functionality
 function exportFilteredData() {
     const dateRange = document.getElementById('dateRange').value;
     const paymentStatus = document.getElementById('paymentStatus').value;
     const orderStatus = document.getElementById('orderStatus').value;
     const paymentMethod = document.getElementById('paymentMethod').value;
     
     // Create export data
     const exportData = {
         filters: {
             date_range: dateRange,
             payment_status: paymentStatus,
             order_status: orderStatus,
             payment_method: paymentMethod
         },
         timestamp: new Date().toISOString(),
         orders: []
     };
     
     // Get visible orders
     const visibleOrders = document.querySelectorAll('.order-item:not([style*="display: none"])');
     visibleOrders.forEach(item => {
         const orderId = item.dataset.orderId;
         const orderIdText = item.querySelector('.order-id')?.textContent;
         const customerName = item.querySelector('.customer-name')?.textContent;
         const orderAmount = item.querySelector('.order-amount')?.textContent;
         const paymentStatus = item.querySelector('.status-badge')?.textContent;
         const orderStatus = item.querySelector('.order-status-badge')?.textContent;
         
         exportData.orders.push({
             order_id: orderId,
             order_oid: orderIdText,
             customer_name: customerName,
             amount: orderAmount,
             payment_status: paymentStatus,
             order_status: orderStatus,
             payment_method: item.dataset.paymentMethod || 'unknown'
         });
     });
     
     // Download as JSON
     const dataStr = JSON.stringify(exportData, null, 2);
     const dataBlob = new Blob([dataStr], {type: 'application/json'});
     const url = URL.createObjectURL(dataBlob);
     const link = document.createElement('a');
     link.href = url;
     link.download = `orders_export_${new Date().toISOString().split('T')[0]}.json`;
     link.click();
     URL.revokeObjectURL(url);
 }
 
 // Quick Actions Enhancement
 function enhanceQuickActions() {
     // Add export button to quick actions
     const quickActionsGrid = document.querySelector('.quick-actions-grid');
     if (quickActionsGrid) {
         const exportButton = document.createElement('a');
         exportButton.href = '#';
         exportButton.className = 'quick-action-button';
         exportButton.onclick = function(e) {
             e.preventDefault();
             exportFilteredData();
         };
         exportButton.innerHTML = `
             <span class="action-icon">📊</span>
             <span class="action-text">Export Data</span>
         `;
         quickActionsGrid.appendChild(exportButton);
     }
 }
 
 // Search functionality
 function searchOrders() {
     const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
     const orderItems = document.querySelectorAll('.order-item');
     
     orderItems.forEach(item => {
         const orderId = item.querySelector('.order-id')?.textContent.toLowerCase() || '';
         const customerName = item.querySelector('.customer-name')?.textContent.toLowerCase() || '';
         const orderAmount = item.querySelector('.order-amount')?.textContent.toLowerCase() || '';
         const paymentStatus = item.querySelector('.status-badge')?.textContent.toLowerCase() || '';
         const orderStatus = item.querySelector('.order-status-badge')?.textContent.toLowerCase() || '';
         
         const matchesSearch = orderId.includes(searchTerm) || 
                             customerName.includes(searchTerm) || 
                             orderAmount.includes(searchTerm) || 
                             paymentStatus.includes(searchTerm) || 
                             orderStatus.includes(searchTerm);
         
         if (matchesSearch || searchTerm === '') {
             item.style.display = 'block';
             item.style.opacity = '1';
         } else {
             item.style.display = 'none';
             item.style.opacity = '0';
         }
     });
     

 }

 function updateDashboardWithRealData() {
     // Don't auto-refresh if filters are being applied manually
     if (filtersBeingApplied) {
         console.log('⏸️ Auto-refresh blocked - filters being applied');
         return;
     }
     console.log('🔄 Auto-refresh running with current filters');
     
     // Get current active filters
     const currentFilters = {
         time_period: document.getElementById('dateRange')?.value || 'week',
         payment_status: document.getElementById('paymentStatus')?.value || 'all',
         order_status: document.getElementById('orderStatus')?.value || 'all',
         payment_method: document.getElementById('paymentMethod')?.value || 'all'
     };
     
     // Build query string with current filters
     const params = new URLSearchParams();
     Object.keys(currentFilters).forEach(key => {
         if (currentFilters[key] && currentFilters[key] !== 'all') {
             params.append(key, currentFilters[key]);
         }
     });
     
     // Fetch filtered data from backend
     console.log('🔄 Auto-refresh fetching data with filters:', currentFilters);
     fetch(`/store/admin/live-orders/?${params.toString()}`)
         .then(response => response.json())
         .then(data => {
             if (data.success) {
                 console.log('📊 Dashboard updated with filtered data:', data.stats);
                 // Update stats with filtered data
                 updateStats(data.stats);
                 
                 // Update performance metrics if available
                 if (data.stats.performance) {
                     updatePerformanceMetricsWithRealData(data.stats.performance);
                 }
                 
                 // Update orders feed with filtered data
                 updateOrdersFeed(data.orders);
             }
         })
         .catch(error => {
             console.error('Error updating dashboard with filtered data:', error);
         });
 }

// Add missing functions
function loadPerformanceMetrics() {
    // Fetch real performance metrics from backend
    fetch('/store/admin/performance-metrics/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePerformanceMetricsWithRealData(data.metrics);
            }
        })
        .catch(error => {
            console.error('Error loading performance metrics:', error);
        });
}





// Add missing functions that were referenced
function enhanceQuickActions() {
    // Add export button to quick actions
    const quickActionsGrid = document.querySelector('.quick-actions-grid');
    if (quickActionsGrid) {
        const exportButton = document.createElement('a');
        exportButton.href = '#';
        exportButton.className = 'quick-action-button';
        exportButton.onclick = function(e) {
            e.preventDefault();
            exportFilteredData();
        };
        exportButton.innerHTML = `
            <span class="action-icon">📊</span>
            <span class="action-text">Export Data</span>
        `;
        quickActionsGrid.appendChild(exportButton);
    }
}

function updatePerformanceMetrics() {
    // Simulate real-time metric updates
    const metricItems = document.querySelectorAll('.metric-item');
    
    metricItems.forEach(item => {
        const metricValue = item.querySelector('.metric-value');
        const metricBar = item.querySelector('.metric-fill');
        
        if (metricValue && metricBar) {
            // Animate the metric bar
            const currentWidth = metricBar.style.width;
            const targetWidth = currentWidth || '0%';
            
            metricBar.style.width = '0%';
            setTimeout(() => {
                metricBar.style.width = targetWidth;
            }, 100);
        }
    });
}

function exportFilteredData() {
    const dateRange = document.getElementById('dateRange').value;
    const paymentStatus = document.getElementById('paymentStatus').value;
    const orderStatus = document.getElementById('orderStatus').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    
    // Create export data
    const exportData = {
        filters: {
            time_period: dateRange,
            payment_status: paymentStatus,
            order_status: orderStatus,
            payment_method: paymentMethod
        },
        timestamp: new Date().toISOString(),
        orders: []
    };
    
    // Get visible orders
    const visibleOrders = document.querySelectorAll('.order-item:not([style*="display: none"])');
    visibleOrders.forEach(item => {
        const orderId = item.dataset.orderId;
        const orderIdText = item.querySelector('.order-id')?.textContent;
        const customerName = item.querySelector('.customer-name')?.textContent;
        const orderAmount = item.querySelector('.order-amount')?.textContent;
        const paymentStatus = item.querySelector('.status-badge')?.textContent;
        const orderStatus = item.querySelector('.order-status-badge')?.textContent;
        
        exportData.orders.push({
            order_id: orderId,
            order_oid: orderIdText,
            customer_name: customerName,
            amount: orderAmount,
            payment_status: paymentStatus,
            order_status: orderStatus,
            payment_method: item.dataset.paymentMethod || 'unknown'
        });
    });
    
    // Download as JSON
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `orders_export_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {

    document.addEventListener('click', function(e) {
        if (e.target.closest('.order-item')) {
            const orderItem = e.target.closest('.order-item');
            const orderId = orderItem.dataset.orderId;
            window.location.href = `/admin/store/cartorder/${orderId}/change/`;
        }
    });
    
         // Start auto-refresh every 5 minutes
     setInterval(refreshOrders, 300000);
     
     // Update dashboard data every 2 minutes
     setInterval(updateDashboardWithRealData, 120000);
     
     
     
     // Also check after DOM changes (but less frequently)
     const observer = new MutationObserver(function(mutations) {
         let shouldApplyStyling = false;
         mutations.forEach(function(mutation) {
             if (mutation.type === 'childList' || mutation.type === 'attributes') {
                 shouldApplyStyling = true;
             }
         });

     });
     
     // Start observing the feed for changes
     const feed = document.getElementById('ordersFeed');
     if (feed) {
         observer.observe(feed, { 
             childList: true, 
             subtree: true, 
             attributes: true 
         });
     }
     
     
     
     // Initialize enhanced features
     enhanceQuickActions();
     updatePerformanceMetrics();
     
     // Set up custom date range handling
     const dateRangeSelect = document.getElementById('dateRange');
     if (dateRangeSelect) {
         dateRangeSelect.addEventListener('change', function() {
             const customDateRange = document.getElementById('customDateRange');
             if (this.value === 'custom') {
                 customDateRange.style.display = 'block';
                 // Set default dates (last 7 days)
                 const endDate = new Date();
                 const startDate = new Date();
                 startDate.setDate(startDate.getDate() - 7);
                 
                 document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                 document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
             } else {
                 customDateRange.style.display = 'none';
             }
         });
     }
     
     // Initialize filters on page load
     applyFilters();
     
     // Set initial change indicators
     updateChangeIndicators('week');
 });
</script>
{% endblock %}
